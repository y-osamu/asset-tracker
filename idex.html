<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>è³‡ç”£ç®¡ç†ã‚¢ãƒ—ãƒª</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { display: flex; font-family: sans-serif; }
    #left { width: 40%; padding: 20px; }
    #right { width: 60%; padding: 20px; }
    input, select, button { font-size: 1em; margin: 5px 0; width: 100%; }
    h2 { margin-bottom: 10px; }
  </style>
</head>
<body>
  <div id="left">
    <h2 id="date">æ—¥ä»˜</h2>
    <h3>ğŸ’° è³‡ç”£ãƒˆãƒ¼ã‚¿ãƒ«ï¼š<span id="total">--</span> å††</h3>
    <p>ãŠãƒ¼ï¼š<input type="number" id="asset-o">å††</p>
    <p>ã¿ãƒ¼ï¼š<input type="number" id="asset-m">å††</p>
    <p>å…±é€šï¼š<input type="number" id="asset-k">å††</p>
    <button onclick="saveAssets()">ä¿å­˜</button>

    <hr />
    <h3>ğŸ“‰ æœ¬æ—¥ã®æ”¯å‡º</h3>
    <select id="category">
      <option value="ãŠãƒ¼">ãŠãƒ¼</option>
      <option value="ã¿ãƒ¼">ã¿ãƒ¼</option>
      <option value="å…±é€š">å…±é€š</option>
    </select>
    <input type="number" id="expense" placeholder="é‡‘é¡ã‚’å…¥åŠ›" />
    <button onclick="addExpense()">ç™»éŒ²</button>
  </div>

  <div id="right">
    <canvas id="assetChart"></canvas>
  </div>

  <script>
    // åˆå›ã‚¢ã‚¯ã‚»ã‚¹æ™‚ï¼šåˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
    if (!localStorage.getItem('appData')) {
      const initData = {
        total: 300000,
        assets: {
          "ãŠãƒ¼": 120000,
          "ã¿ãƒ¼": 100000,
          "å…±é€š": 80000
        },
        monthlyAssets: {
          "2025-01": null,
          "2025-02": null,
          "2025-03": null,
          "2025-04": 300000
        }
      };
      localStorage.setItem('appData', JSON.stringify(initData));
    }

    // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    let data = JSON.parse(localStorage.getItem('appData'));
    const today = new Date();
    const thisMonthKey = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
    const dateStr = today.toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric' });
    document.getElementById('date').textContent = dateStr;

    // è¡¨ç¤ºã«åæ˜ 
    document.getElementById('asset-o').value = data.assets["ãŠãƒ¼"];
    document.getElementById('asset-m').value = data.assets["ã¿ãƒ¼"];
    document.getElementById('asset-k').value = data.assets["å…±é€š"];
    document.getElementById('total').textContent = data.total;

    function saveAssets() {
      const o = parseInt(document.getElementById('asset-o').value) || 0;
      const m = parseInt(document.getElementById('asset-m').value) || 0;
      const k = parseInt(document.getElementById('asset-k').value) || 0;
      const total = o + m + k;

      data.assets["ãŠãƒ¼"] = o;
      data.assets["ã¿ãƒ¼"] = m;
      data.assets["å…±é€š"] = k;
      data.total = total;
      data.monthlyAssets[thisMonthKey] = total;

      localStorage.setItem('appData', JSON.stringify(data));
      document.getElementById('total').textContent = total;
      alert("ä¿å­˜ã—ã¾ã—ãŸï¼");
      updateChart();
    }

    function addExpense() {
      const category = document.getElementById('category').value;
      const amount = parseInt(document.getElementById('expense').value);
      if (isNaN(amount) || amount <= 0) {
        alert("é‡‘é¡ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„");
        return;
      }

      // æ¸›ç®—å‡¦ç†
      data.assets[category] = Math.max(0, data.assets[category] - amount);
      data.total = data.assets["ãŠãƒ¼"] + data.assets["ã¿ãƒ¼"] + data.assets["å…±é€š"];
      data.monthlyAssets[thisMonthKey] = data.total;

      // ä¿å­˜
      localStorage.setItem('appData', JSON.stringify(data));

      // è¡¨ç¤ºæ›´æ–°
      document.getElementById('asset-o').value = data.assets["ãŠãƒ¼"];
      document.getElementById('asset-m').value = data.assets["ã¿ãƒ¼"];
      document.getElementById('asset-k').value = data.assets["å…±é€š"];
      document.getElementById('total').textContent = data.total;

      // ã‚°ãƒ©ãƒ•æ›´æ–°
      updateChart();

      // å…¥åŠ›ãƒªã‚»ãƒƒãƒˆ
      document.getElementById('expense').value = '';
      alert("æ”¯å‡ºã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼");
    }

    function getPastFourMonths() {
      const result = [];
      const now = new Date();
      for (let i = 3; i >= 0; i--) {
        const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
        result.push(key);
      }
      return result;
    }

    function getMonthlyValues() {
      const keys = getPastFourMonths();
      return keys.map(k => data.monthlyAssets[k] ?? 0);
    }

    const chartCtx = document.getElementById('assetChart').getContext('2d');
    const chart = new Chart(chartCtx, {
      type: 'bar',
      data: {
        labels: getPastFourMonths().map(k => `${parseInt(k.split('-')[1])}æœˆ`),
        datasets: [{
          label: 'è³‡ç”£æ¨ç§»',
          data: getMonthlyValues()
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: { beginAtZero: true }
        }
      }
    });

    function updateChart() {
      chart.data.datasets[0].data = getMonthlyValues();
      chart.update();
    }
  </script>
</body>
</html>
